<%# Header with breadcrumb, notifications, user menu %>
<header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 lg:px-8 flex-shrink-0">
  <%# Left side - Mobile menu + Breadcrumb %>
  <div class="flex items-center">
    <%# Mobile menu button %>
    <button type="button" class="lg:hidden mr-4 p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100" data-action="click->sidebar#toggle">
      <i class="fa-solid fa-bars text-xl"></i>
    </button>

    <%# Breadcrumb %>
    <nav class="flex items-center text-sm">
      <% if content_for?(:breadcrumb) %>
        <%= yield :breadcrumb %>
      <% else %>
        <span class="text-gray-800 font-medium"><%= content_for?(:page_title) ? yield(:page_title) : "T·ªïng quan" %></span>
      <% end %>
    </nav>
  </div>

  <%# Right side - Connection Status + Notifications + User menu %>
  <div class="flex items-center space-x-6">
    <%# TASK-055b: Connection Status Indicator %>
    <div data-controller="connection-status" 
         class="flex items-center space-x-2 cursor-pointer" 
         title="Tr·∫°ng th√°i k·∫øt n·ªëi real-time"
         data-action="click->connection-status#reconnect">
      <span data-connection-status-target="indicator" class="h-2.5 w-2.5 rounded-full bg-gray-400"></span>
      <span data-connection-status-target="text" class="text-xs font-medium text-gray-500 hidden sm:block">ƒêang k·∫øt n·ªëi...</span>
    </div>
    
    <%# Notification bell - TASK-057: Dynamic notifications %>
    <%# TASK-035: Real-time subscription for badge updates %>
    <%= turbo_stream_from "user_#{current_user.id}_notifications" %>
    
    <% unread_count = current_user.notifications.unread.count rescue 0 %>
    <div class="relative" data-controller="dropdown notification-dropdown">
      <button type="button" data-action="click->dropdown#toggle click->notification-dropdown#refresh" class="relative p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none">
        <%# Badge with Turbo target for real-time updates %>
        <span id="notification_badge" class="<%= unread_count > 0 ? '' : 'hidden' %> absolute -top-1 -right-1 flex items-center justify-center h-5 w-5 rounded-full bg-brand-red text-white text-xs font-bold ring-2 ring-white">
          <%= unread_count > 0 ? (unread_count > 9 ? '9+' : unread_count) : '' %>
        </span>
        <i class="fa-regular fa-bell text-xl"></i>
      </button>

      <%# Notification dropdown %>
      <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
        <%# Turbo Frame for lazy loading notifications %>
        <turbo-frame id="notification_dropdown_content" src="<%= dropdown_notifications_path %>" loading="lazy">
          <div class="px-4 py-8 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mb-2 text-gray-300"></i>
            <p class="text-sm">ƒêang t·∫£i...</p>
          </div>
        </turbo-frame>
      </div>
    </div>

    <%# User menu %>
    <div class="relative" data-controller="dropdown">
      <button type="button" data-action="click->dropdown#toggle" class="flex items-center">
        <% if user_signed_in? %>
          <%= image_tag "https://ui-avatars.com/api/?name=#{current_user.email.first}&background=0B387A&color=fff", class: "h-8 w-8 rounded-full object-cover border border-gray-200", alt: "Avatar" %>
          <span class="ml-3 text-sm font-medium text-gray-700 hidden sm:block"><%= current_user.email.split('@').first %></span>
        <% else %>
          <i class="fa-solid fa-user-circle text-2xl text-gray-400"></i>
        <% end %>
        <i class="fa-solid fa-chevron-down ml-2 text-xs text-gray-400"></i>
      </button>

      <%# User dropdown %>
      <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
        <% if user_signed_in? %>
          <%= link_to "#", class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
            <i class="fa-solid fa-user mr-2 text-gray-400"></i> H·ªì s∆° c√° nh√¢n
          <% end %>
          <%= link_to "#", class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
            <i class="fa-solid fa-gear mr-2 text-gray-400"></i> C√†i ƒë·∫∑t
          <% end %>
          
          <%# TASK-056: Web Push subscription toggle %>
          <div data-controller="push-subscription" class="border-t border-gray-100">
            <button 
              data-push-subscription-target="button"
              data-action="click->push-subscription#toggle"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              <i class="fa-solid fa-bell mr-2 text-gray-400"></i>
              <span>üîï B·∫≠t th√¥ng b√°o</span>
            </button>
            <span data-push-subscription-target="status" class="hidden px-4 py-1 text-xs"></span>
          </div>
          
          <div class="border-t border-gray-100"></div>
          <%= link_to destroy_user_session_path, data: { turbo_method: :delete }, class: "block px-4 py-2 text-sm text-red-600 hover:bg-red-50" do %>
            <i class="fa-solid fa-right-from-bracket mr-2"></i> ƒêƒÉng xu·∫•t
          <% end %>
        <% else %>
          <%= link_to new_user_session_path, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" do %>
            <i class="fa-solid fa-right-to-bracket mr-2 text-gray-400"></i> ƒêƒÉng nh·∫≠p
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</header>
