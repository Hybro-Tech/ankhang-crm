<%= form_with(model: contact, url: contacts_path, 
    data: { 
      controller: "reset-form call-center-mode", 
      action: "turbo:submit-end->reset-form#reset" 
    }, 
    class: "flex flex-col h-full") do |form| %>

  <!-- Mode Switcher (Segmented Toggle) -->
  <div class="flex items-center justify-center mb-6">
    <div class="flex p-1 bg-gray-100 rounded-lg shadow-inner border border-gray-200">
      <button type="button" 
              data-call-center-mode-target="modePhoneBtn"
              data-action="click->call-center-mode#switchToPhone"
              class="flex items-center gap-2 px-6 py-2 rounded-md font-bold transition-all text-sm bg-brand-blue text-white shadow-sm">
        <i class="fa-solid fa-phone"></i> <span>Số điện thoại</span>
      </button>
      <button type="button" 
              data-call-center-mode-target="modeZaloBtn"
              data-action="click->call-center-mode#switchToZalo"
              class="flex items-center gap-2 px-6 py-2 rounded-md font-medium text-sm text-gray-500 hover:text-gray-900 transition-all">
        <i class="fa-solid fa-comment-dots"></i> <span>Zalo</span>
      </button>
    </div>
    <input type="hidden" name="identity_source" value="phone" data-call-center-mode-target="identityInput">
  </div>
  
  <div class="space-y-5 flex-1 overflow-y-auto px-1">
    
    <!-- SECTION: IDENTITY (Phone or Zalo) -->
    <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-sm mb-6">
      
      <!-- MODE: PHONE -->
      <div data-call-center-mode-target="phoneSection">
        <%= form.label :phone, "Số điện thoại *", class: "block text-sm font-bold text-gray-800 mb-2" %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <i class="fa-solid fa-phone text-gray-400 text-lg"></i>
          </div>
          <%= form.text_field :phone, 
              class: "pl-12 w-full rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-2xl font-mono tracking-wider font-bold text-gray-900 placeholder-gray-300 py-3 transition-colors",
              placeholder: "09xx xxx xxx",
              data: { 
                call_center_mode_target: "phoneInput",
                controller: "identity-lookup",
                identity_lookup_type_value: "phone",
                action: "input->identity-lookup#search blur->identity-lookup#check"
              } %>
        </div>
        <p class="text-xs text-brand-orange mt-2 hidden" id="phone_duplicate_warning">
           <i class="fa-solid fa-triangle-exclamation mr-1"></i> SĐT đã tồn tại!
        </p>
      </div>

      <!-- MODE: ZALO -->
      <div data-call-center-mode-target="zaloSection" class="hidden space-y-5">
        <div>
          <%= form.label :zalo_id, "Zalo Phonenumber / Username *", class: "block text-sm font-bold text-gray-800 mb-2" %>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
               <span class="font-bold text-blue-600 text-lg">Z</span>
            </div>
             <%= form.text_field :zalo_id, 
                class: "pl-12 w-full rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-lg font-medium text-gray-900 py-3 transition-colors",
                placeholder: "VD: 0912345678 hoặc huyentrang9x",
                data: { 
                    call_center_mode_target: "zaloInput",
                    controller: "identity-lookup",
                    identity_lookup_type_value: "zalo",
                    action: "input->identity-lookup#search blur->identity-lookup#check"
                } %>
          </div>
        </div>
       
        <div>
          <%= form.label :zalo_qr, "Ảnh QR Code (Nếu có)", class: "block text-sm font-bold text-gray-800 mb-2" %>
          <div class="flex items-center justify-center w-full">
              <label for="contact_zalo_qr" class="flex flex-col items-center justify-center w-full h-28 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-white hover:bg-gray-50 transition-all">
                  <div class="flex flex-col items-center justify-center pt-5 pb-6">
                      <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-3xl mb-3"></i>
                      <p class="text-sm text-gray-500 font-medium">Click to upload QR Image</p>
                  </div>
                  <%= form.file_field :zalo_qr, class: "hidden" %>
              </label>
          </div> 
        </div>
      </div>

    </div>

    <!-- COMMON FIELDS -->
    <div class="space-y-5">
      <div>
        <%= form.label :name, "Họ tên Khách hàng", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= form.text_field :name, 
            class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue transition-colors font-medium text-gray-900 placeholder-gray-400",
            placeholder: "Nhập tên..." %>
      </div>

      <div class="grid grid-cols-2 gap-5">
        <div>
          <%= form.label :service_type_id, "Nhu cầu *", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= form.collection_select :service_type_id, @service_types || [], :id, :name, { prompt: "-- Chọn --" }, 
              { class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue transition-colors font-medium text-gray-900" } %>
        </div>
        <div>
          <%= form.label :source, "Nguồn", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= form.select :source, Contact.sources.keys.map { |k| [t("contacts.source.#{k}"), k] }, { selected: "ladi_zalo_hotline" }, 
              { class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue transition-colors font-medium text-gray-900" } %>
        </div>
      </div>
       
       <div>
        <%= form.label :note, "Ghi chú tư vấn", class: "block text-sm font-bold text-gray-700 mb-2" %>
        <%= form.text_area :note, rows: 4, 
            class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue transition-colors text-gray-900 placeholder-gray-400",
            placeholder: "Khách quan tâm vấn đề gì..." %>
      </div>
      <!-- Actions -->
      <div class="pt-6 pb-2 flex items-center justify-end border-t border-gray-100 mt-4">
        <%= form.submit "LƯU CONTACT", 
            class: "bg-brand-blue text-white px-8 py-3 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue font-bold text-lg transition-transform active:scale-95 w-full md:w-auto" %>
      </div>
    </div> <!-- Close common fields div -->
  </div> <!-- Close scrollable container -->

<% end %>
