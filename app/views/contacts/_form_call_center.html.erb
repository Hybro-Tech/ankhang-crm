<%= turbo_frame_tag "new_contact_form", class: "h-full w-full block", data: { turbo_action: "advance" } do %>
  <%= form_with(model: contact, url: contacts_path, 
      data: { 
        controller: "reset-form call-center-mode", 
        action: "turbo:submit-end->reset-form#reset" 
      }, 
      class: "flex flex-col h-full") do |form| %>

    <!-- Mode Switcher (Segmented Toggle) -->
    <div class="flex items-center justify-center mb-6">
      <div class="flex p-1 bg-gray-100 rounded-lg shadow-inner border border-gray-200">
        <button type="button" 
                data-call-center-mode-target="modePhoneBtn"
                data-action="click->call-center-mode#switchToPhone"
                class="flex items-center gap-2 px-6 py-2 rounded-md font-bold transition-all text-sm bg-brand-blue text-white shadow-sm">
          <i class="fa-solid fa-phone"></i> <span>Số điện thoại</span>
        </button>
        <button type="button" 
                data-call-center-mode-target="modeZaloBtn"
                data-action="click->call-center-mode#switchToZalo"
                class="flex items-center gap-2 px-6 py-2 rounded-md font-medium text-sm text-gray-500 hover:text-gray-900 transition-all">
          <i class="fa-solid fa-comment-dots"></i> <span>Zalo</span>
        </button>
      </div>
      <input type="hidden" name="identity_source" value="phone" data-call-center-mode-target="identityInput">
    </div>
    
    <div class="space-y-5 flex-1 overflow-y-auto px-1">
      
      <!-- SECTION: IDENTITY (Phone or Zalo) -->
      <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-sm mb-6">
        
        <!-- MODE: PHONE -->
        <div data-call-center-mode-target="phoneSection">
          <%= form.label :phone, "Số điện thoại *", class: "block text-sm font-bold text-gray-800 mb-2" %>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fa-solid fa-phone text-gray-400 text-lg"></i>
            </div>
            <%= form.text_field :phone, 
                class: "pl-12 w-full rounded-lg border #{contact.errors[:phone].any? ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-gray-300 focus:ring-brand-blue focus:border-brand-blue'} bg-white focus:ring-2 text-2xl font-mono tracking-wider font-bold text-gray-900 placeholder-gray-300 py-3 transition-colors",
                placeholder: "09xx xxx xxx",
                data: { 
                  call_center_mode_target: "phoneInput",
                  controller: "identity-lookup phone-format",
                  identity_lookup_type_value: "phone",
                  action: "input->phone-format#format input->identity-lookup#search blur->identity-lookup#check"
                } %>
          </div>
          <% if contact.errors[:phone].any? %>
            <p class="mt-1 text-sm text-red-600"><%= contact.errors[:phone].first %></p>
          <% end %>
          <p class="text-xs text-brand-orange mt-2 hidden" id="phone_duplicate_warning">
             <i class="fa-solid fa-triangle-exclamation mr-1"></i> SĐT đã tồn tại!
          </p>
        </div>

        <!-- MODE: ZALO -->
        <div data-call-center-mode-target="zaloSection" class="hidden space-y-5">
          <div>
            <%= form.label :zalo_id, "Zalo Phonenumber / Username *", class: "block text-sm font-bold text-gray-800 mb-2" %>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                 <span class="font-bold text-blue-600 text-lg">Z</span>
              </div>
               <%= form.text_field :zalo_id, 
                  class: "pl-12 w-full rounded-lg border #{contact.errors[:zalo_id].any? ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-gray-300 focus:ring-brand-blue focus:border-brand-blue'} bg-white focus:ring-2 text-lg font-medium text-gray-900 py-3 transition-colors",
                  placeholder: "VD: 0912345678 hoặc huyentrang9x",
                  data: { 
                      call_center_mode_target: "zaloInput",
                      controller: "identity-lookup",
                      identity_lookup_type_value: "zalo",
                      action: "input->identity-lookup#search blur->identity-lookup#check"
                  } %>
            </div>
            <% if contact.errors[:zalo_id].any? %>
              <p class="mt-1 text-sm text-red-600"><%= contact.errors[:zalo_id].first %></p>
            <% end %>
          </div>
         
          <div>
            <%= form.label :zalo_qr, "Ảnh QR Code (Nếu có)", class: "block text-sm font-bold text-gray-800 mb-2" %>
            <div class="relative">
                <label for="contact_zalo_qr" class="flex items-center gap-3 w-full rounded-lg border border-gray-300 bg-white hover:bg-gray-50 px-4 py-3 cursor-pointer transition-colors group">
                    <div class="flex items-center justify-center w-8">
                       <i class="fa-solid fa-qrcode text-gray-400 group-hover:text-brand-blue text-xl"></i>
                    </div>
                    <span class="text-gray-500 font-medium flex-1 truncate">Upload ảnh QR Code...</span>
                    <i class="fa-solid fa-cloud-arrow-up text-gray-400 group-hover:text-brand-blue"></i>
                    <%= form.file_field :zalo_qr, class: "hidden", onchange: "this.previousElementSibling.previousElementSibling.innerText = this.files[0] ? this.files[0].name : 'Upload ảnh QR Code...'" %>
                </label>
            </div> 
          </div>
        </div>

      </div>

      <!-- COMMON FIELDS -->
      <div class="space-y-5">
        <div>
          <%= form.label :name, "Họ tên Khách hàng", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= form.text_field :name, 
              class: "w-full px-4 py-2.5 border rounded-lg focus:ring-2 transition-colors font-medium text-gray-900 placeholder-gray-400 #{contact.errors[:name].any? ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-gray-300 focus:ring-brand-blue focus:border-brand-blue'}",
              placeholder: "Nhập tên..." %>
          <% if contact.errors[:name].any? %>
            <p class="mt-1 text-sm text-red-600"><%= contact.errors[:name].first %></p>
          <% end %>
        </div>

        <div class="grid grid-cols-2 gap-5">
          <div>
            <%= form.label :service_type_id, "Nhu cầu *", class: "block text-sm font-bold text-gray-700 mb-2" %>
            <%= form.collection_select :service_type_id, @service_types || [], :id, :name, { prompt: "-- Chọn --" }, 
                { class: "w-full", data: { controller: "tom-select", tom_select_placeholder_value: "Chọn nhu cầu..." } } %>
            <% if contact.errors[:service_type_id].any? %>
              <p class="mt-1 text-sm text-red-600"><%= contact.errors[:service_type_id].first %></p>
            <% end %>
          </div>
          <div>
            <%= form.label :source_id, "Nguồn *", class: "block text-sm font-bold text-gray-700 mb-2" %>
            <%= form.collection_select :source_id, Source.for_dropdown, :id, :name, { include_blank: "-- Chọn --" }, 
                { class: "w-full", data: { controller: "tom-select", tom_select_placeholder_value: "Chọn nguồn..." } } %>
            <% if contact.errors[:source].any? %>
              <p class="mt-1 text-sm text-red-600"><%= contact.errors[:source].first %></p>
            <% end %>
          </div>
        </div>
         
         <div>
          <%= form.label :note, "Ghi chú tư vấn", class: "block text-sm font-bold text-gray-700 mb-2" %>
          <%= form.text_area :note, rows: 4, 
              class: "w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue transition-colors text-gray-900 placeholder-gray-400",
              placeholder: "Khách quan tâm vấn đề gì..." %>
        </div>
        <!-- Actions -->
        <div class="pt-6 pb-2 flex items-center justify-end border-t border-gray-100 mt-4">
          <button type="submit" 
              class="inline-flex items-center gap-2 px-6 py-2.5 bg-[#0B387A] hover:bg-blue-800 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue">
            <i class="fa-solid fa-floppy-disk"></i>
            <span>Lưu Contact</span>
          </button>
        </div>
      </div> <!-- Close common fields div -->
    </div> <!-- Close scrollable container -->
  <% end %>
<% end %>
