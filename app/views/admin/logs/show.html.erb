<%# TASK-LOGGING: Activity Log Detail Modal %>
<turbo-frame id="log_modal">
  <div class="fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <%# Backdrop %>
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
         data-action="click->modal#close"
         data-turbo-frame="log_modal"></div>

    <%# Modal Panel %>
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <%# Header %>
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
          <h3 class="text-lg font-semibold text-gray-900">Chi tiết nhật ký hoạt động</h3>
          <%= link_to admin_logs_path, class: "text-gray-400 hover:text-gray-600 transition-colors", data: { turbo_frame: "log_modal" } do %>
            <i class="fa-solid fa-xmark text-xl"></i>
          <% end %>
        </div>

        <%# Content %>
        <div class="px-6 py-4 overflow-y-auto max-h-[70vh]">
          <dl class="space-y-4">
            <%# ID %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">ID</dt>
              <dd class="text-sm text-gray-900"><%= @log.id %></dd>
            </div>

            <%# Thời gian %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Thời gian</dt>
              <dd class="text-sm text-gray-900"><%= @log.created_at.strftime("%d/%m/%Y %H:%M:%S") %></dd>
            </div>

            <%# Người thực hiện %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Người thực hiện</dt>
              <dd class="text-sm text-gray-900">
                <%= @log.user_name || @log.user&.name || "Hệ thống" %>
                <% if @log.user_id %>
                  <span class="text-gray-400">(ID: <%= @log.user_id %>)</span>
                <% end %>
              </dd>
            </div>

            <%# Hành động %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Hành động</dt>
              <dd>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= action_badge_class(@log.action) %>">
                  <%= @log.action %>
                </span>
              </dd>
            </div>

            <%# Phân loại %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Phân loại</dt>
              <dd class="text-sm text-gray-900"><%= @log.category&.titleize || "—" %></dd>
            </div>

            <%# Đối tượng %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Đối tượng</dt>
              <dd class="text-sm text-brand-blue font-medium">
                <% if @log.subject_type.present? %>
                  <%= @log.subject_type %>#<%= @log.subject_id %>
                <% else %>
                  <span class="text-gray-400">—</span>
                <% end %>
              </dd>
            </div>

            <%# IP Address %>
            <div class="flex">
              <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Địa chỉ IP</dt>
              <dd class="text-sm text-gray-900 font-mono"><%= @log.ip_address || "—" %></dd>
            </div>

            <%# User Agent %>
            <% if @log.user_agent.present? %>
              <div class="flex">
                <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">User Agent</dt>
                <dd class="text-sm text-gray-600 break-all"><%= @log.user_agent %></dd>
              </div>
            <% end %>

            <%# Request ID %>
            <% if @log.request_id.present? %>
              <div class="flex">
                <dt class="w-32 flex-shrink-0 text-sm font-medium text-gray-500">Request ID</dt>
                <dd class="text-sm text-gray-600 font-mono"><%= @log.request_id %></dd>
              </div>
            <% end %>

            <%# Chi tiết thay đổi %>
            <% if @log.record_changes.present? %>
              <div class="border-t border-gray-100 pt-4">
                <dt class="text-sm font-medium text-gray-500 mb-3">Chi tiết thay đổi</dt>
                <dd>
                  <% changes = @log.record_changes.is_a?(String) ? (JSON.parse(@log.record_changes) rescue {}) : @log.record_changes %>
                  <% if changes.any? %>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                      <% changes.each do |field, values| %>
                        <div class="border-b border-gray-200 pb-2 last:border-0 last:pb-0">
                          <div class="text-xs font-semibold text-gray-700 mb-1"><%= field %></div>
                          <% if values.is_a?(Array) && values.length == 2 %>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                              <div class="flex-1">
                                <span class="text-xs text-gray-500">Trước:</span>
                                <div class="text-sm text-red-600 bg-red-50 px-2 py-1 rounded mt-1 break-all">
                                  <%= values[0].nil? ? "(trống)" : values[0].to_s.truncate(200) %>
                                </div>
                              </div>
                              <i class="fa-solid fa-arrow-right text-gray-400 hidden sm:block"></i>
                              <i class="fa-solid fa-arrow-down text-gray-400 sm:hidden self-center"></i>
                              <div class="flex-1">
                                <span class="text-xs text-gray-500">Sau:</span>
                                <div class="text-sm text-green-600 bg-green-50 px-2 py-1 rounded mt-1 break-all">
                                  <%= values[1].nil? ? "(trống)" : values[1].to_s.truncate(200) %>
                                </div>
                              </div>
                            </div>
                          <% else %>
                            <div class="text-sm text-gray-800 bg-gray-100 px-2 py-1 rounded break-all">
                              <%= values.to_s.truncate(300) %>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-gray-400">Không có thay đổi</span>
                  <% end %>
                </dd>
              </div>
            <% end %>
          </dl>
        </div>

        <%# Footer %>
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
          <%= link_to admin_logs_path, class: "w-full inline-flex justify-center items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer", data: { turbo_frame: "log_modal" } do %>
            Đóng
          <% end %>
        </div>
      </div>
    </div>
  </div>
</turbo-frame>
