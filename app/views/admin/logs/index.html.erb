<%# TASK-LOGGING: Activity Logs Index View %>
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Nhật ký hoạt động</h1>
    <p class="text-sm text-gray-500 mt-1">Theo dõi lịch sử thao tác trong hệ thống (Tier 1)</p>
  </div>
  <div class="flex items-center space-x-3">
    <%= link_to events_admin_logs_path, class: "bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 flex items-center cursor-pointer transition-colors duration-200" do %>
      <i class="fa-solid fa-globe mr-2"></i> User Events
    <% end %>
    <%= link_to admin_logs_path(format: :csv, **request.query_parameters), class: "bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 flex items-center cursor-pointer transition-colors duration-200" do %>
      <i class="fa-solid fa-download mr-2"></i> Xuất CSV
    <% end %>
  </div>
</div>

<%# Filters %>
<%= form_with url: admin_logs_path, method: :get, class: "bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6" do %>
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Từ ngày</label>
      <%= date_field_tag :date_from, params[:date_from], class: "w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-brand-blue" %>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Đến ngày</label>
      <%= date_field_tag :date_to, params[:date_to], class: "w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-brand-blue" %>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Người thực hiện</label>
      <%= select_tag :user_id, options_from_collection_for_select(@users, :id, :name, params[:user_id]), include_blank: "Tất cả", class: "w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none bg-white" %>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Phân loại</label>
      <%= select_tag :category, options_for_select(@categories.map { |c| [c.titleize, c] }, params[:category]), include_blank: "Tất cả", class: "w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none bg-white" %>
    </div>
    <div class="flex items-end">
      <%= submit_tag "Lọc", class: "w-full bg-brand-blue text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 cursor-pointer" %>
    </div>
  </div>
<% end %>

<%# Stats %>
<div class="mb-4 text-sm text-gray-500">
  Hiển thị <%= @logs.size %> trong tổng số <%= @logs.total_count %> bản ghi
</div>

<%# Logs Table %>
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người thực hiện</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đối tượng</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi tiết thay đổi</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <% @logs.each do |log| %>
        <tr class="hover:bg-gray-50 transition-colors duration-150">
          <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">
            <%= log.created_at.strftime("%d/%m/%Y %H:%M:%S") %>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">
              <%= log.user_name || log.user&.name || "Hệ thống" %>
            </div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-brand-blue font-medium">
            <% if log.subject %>
              <%= "#{log.subject_type}##{log.subject_id}" %>
            <% else %>
              <span class="text-gray-400">—</span>
            <% end %>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= action_badge_class(log.action) %>">
              <%= log.action %>
            </span>
          </td>
          <td class="px-4 py-3 text-xs text-gray-600 max-w-xs">
            <% if log.record_changes.present? %>
              <% changes = log.record_changes.is_a?(String) ? (JSON.parse(log.record_changes) rescue {}) : log.record_changes %>
              <% if changes.any? %>
                <div class="space-y-1">
                  <% changes.first(3).each do |field, values| %>
                    <div class="truncate" title="<%= field %>: <%= values.inspect %>">
                      <span class="font-medium text-gray-700"><%= field %>:</span>
                      <% if values.is_a?(Array) && values.length == 2 %>
                        <span class="text-red-500 line-through"><%= values[0].to_s.truncate(15) %></span>
                        <span class="mx-1">→</span>
                        <span class="text-green-600"><%= values[1].to_s.truncate(15) %></span>
                      <% else %>
                        <span><%= values.to_s.truncate(30) %></span>
                      <% end %>
                    </div>
                  <% end %>
                  <% if changes.size > 3 %>
                    <div class="text-gray-400 text-xs">+<%= changes.size - 3 %> thay đổi khác</div>
                  <% end %>
                </div>
              <% else %>
                <span class="text-gray-400">—</span>
              <% end %>
            <% else %>
              <span class="text-gray-400">—</span>
            <% end %>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">
            <%= log.ip_address || "—" %>
          </td>
        </tr>
      <% end %>
      <% if @logs.empty? %>
        <tr>
          <td colspan="6" class="px-4 py-8 text-center text-gray-500">
            Không có dữ liệu
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<%# Pagination %>
<div class="mt-4">
  <%= paginate @logs %>
</div>
