<%# TASK-035: Real-time subscription for contacts - must be OUTSIDE turbo-frame to persist %>
<%= turbo_stream_from "user_#{current_user.id}_contacts" %>

<div class="min-h-screen bg-white" 
     data-controller="workspace-tabs highlight"
     data-workspace-tabs-slide-over-outlet="#main-slide-over">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 px-6 py-4 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-gray-900">
          Chào <%= current_user.name.split.first %>, 
          <%# TODO: Add @kpis[:needs_update] back when re-enabling "Cần cập nhật" tab %>
          <span class="font-normal text-gray-600">hôm nay có <%= @kpis[:new_contacts] + @kpis[:appointments_today] %> việc cần làm</span>
        </h1>
      </div>
      <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2 text-sm">
              <span id="kpi_new_contacts" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-brand-blue font-bold"><%= @kpis[:new_contacts] %></span>
              <span class="text-gray-600">Khách mới</span>
            </div>
            <% if false # TODO: Uncomment when re-enabling "Cần cập nhật" feature %>
            <div class="flex items-center space-x-2 text-sm">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-600 font-bold"><%= @kpis[:needs_update] %></span>
              <span class="text-gray-600">Cần cập nhật</span>
            </div>
            <% end %>
            <div class="flex items-center space-x-2 text-sm">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 font-bold"><%= @kpis[:appointments_today] %></span>
              <span class="text-gray-600">Hẹn hôm nay</span>
            </div>
            <%# TASK-052: Pending Requests KPI for Team Leaders - always show for team leaders %>
            <% if current_user.team_leader? %>
              <div class="flex items-center space-x-2 text-sm">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold"><%= @kpis[:pending_requests] %></span>
                <span class="text-gray-600">Chờ duyệt</span>
              </div>
            <% end %>
          </div>
        </div>
    </div>
  </div>

  <!-- Main Content: 70/30 Split -->
  <div class="flex px-6 gap-6">
    <!-- Left Panel: Work Area (70%) -->
    <div class="w-full lg:w-[70%]">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <!-- Tabs -->
        <div class="border-b border-gray-200">
          <nav class="flex -mb-px" aria-label="Tabs">
            <button type="button"
                    class="workspace-tab group relative min-w-0 flex-1 overflow-hidden py-4 px-6 text-sm font-medium text-center border-b-2 focus:z-10 transition-colors"
                    data-workspace-tabs-target="tab"
                    data-tab="new_contacts"
                    data-action="click->workspace-tabs#switchTab"
                    aria-selected="true">
              <span class="flex items-center justify-center space-x-2">
                <i class="fa-solid fa-user-plus text-brand-blue"></i>
                <span>Khách mới</span>
                <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold bg-blue-500 text-white rounded-full">
                  <%= @kpis[:new_contacts] %>
                </span>
              </span>
            </button>
            <% if false # TODO: Uncomment when re-enabling "Cần cập nhật" feature %>
            <button type="button"
                    class="workspace-tab group relative min-w-0 flex-1 overflow-hidden py-4 px-6 text-sm font-medium text-center border-b-2 focus:z-10 transition-colors"
                    data-workspace-tabs-target="tab"
                    data-tab="needs_update"
                    data-action="click->workspace-tabs#switchTab">
              <span class="flex items-center justify-center space-x-2">
                <i class="fa-solid fa-pen-to-square text-orange-500"></i>
                <span>Cần cập nhật (<%= @kpis[:needs_update] %>)</span>
              </span>
            </button>
            <% end %>
            <%# TASK-064: Renamed from in_progress to potential %>
            <button type="button"
                    class="workspace-tab group relative min-w-0 flex-1 overflow-hidden py-4 px-6 text-sm font-medium text-center border-b-2 focus:z-10 transition-colors"
                    data-workspace-tabs-target="tab"
                    data-tab="potential"
                    data-action="click->workspace-tabs#switchTab">
              <span class="flex items-center justify-center space-x-2">
                <i class="fa-solid fa-spinner text-teal-500"></i>
                <span>Đang chăm sóc</span>
                <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold bg-teal-500 text-white rounded-full">
                  <%= @kpis[:potential] %>
                </span>
              </span>
            </button>
            <%# TASK-052: Pending Requests Tab for Team Leaders - always show for team leaders %>
            <% if current_user.team_leader? %>
              <button type="button"
                      class="workspace-tab group relative min-w-0 flex-1 overflow-hidden py-4 px-6 text-sm font-medium text-center border-b-2 focus:z-10 transition-colors"
                      data-workspace-tabs-target="tab"
                      data-tab="pending_requests"
                      data-action="click->workspace-tabs#switchTab">
                <span class="flex items-center justify-center space-x-2">
                  <i class="fa-solid fa-clipboard-check text-red-500"></i>
                  <span>Yêu cầu duyệt</span>
                  <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full">
                    <%= @kpis[:pending_requests] %>
                  </span>
                </span>
              </button>
            <% end %>
          </nav>
        </div>

        <!-- Tab Content (Turbo Frame) -->
        <turbo-frame id="contact_list_frame" data-workspace-tabs-target="frame" src="/sales/workspace/tab_new_contacts">
          <div class="p-8 text-center text-gray-400">
            <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
            <p class="mt-2 text-sm">Đang tải...</p>
          </div>
        </turbo-frame>
      </div>
    </div>

    <!-- Right Panel: Context Panel (30%) -->
    <div class="hidden lg:block lg:w-[30%] space-y-6">
      <!-- Appointments with Load More -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">
            <i class="fa-solid fa-calendar-check text-brand-blue mr-2"></i>Lịch hẹn sắp tới
            <% if @appointments.any? %>
              <span class="ml-2 text-xs font-normal text-gray-500">(<%= @total_appointments %> lịch hẹn)</span>
            <% end %>
          </h3>
          <% if @total_appointments.to_i > 5 %>
            <a href="#" class="text-xs text-brand-blue hover:underline">Xem tất cả</a>
          <% end %>
        </div>
        
        <%# Fixed height container with scroll %>
        <turbo-frame id="appointments_list">
          <div class="max-h-72 overflow-y-auto" data-controller="infinite-scroll" data-infinite-scroll-url-value="<%= sales_workspace_more_appointments_path %>">
            <ul class="divide-y divide-gray-100" data-infinite-scroll-target="entries">
              <% @appointments.each do |appointment| %>
                <%= render "sales_workspace/appointment_item", appointment: appointment %>
              <% end %>
            </ul>
            
            <% if @appointments.empty? %>
              <div class="p-6 text-center text-sm text-gray-500">
                <i class="fa-regular fa-calendar-xmark text-2xl text-gray-300 mb-2"></i>
                <p>Không có lịch hẹn nào.</p>
              </div>
            <% elsif @appointments.size < @total_appointments.to_i %>
              <%# Load more trigger %>
              <div id="load_more_appointments" class="p-3 text-center border-t border-gray-100" data-infinite-scroll-target="pagination">
                <button type="button" 
                        class="text-sm text-brand-blue hover:underline"
                        data-action="click->infinite-scroll#loadMore"
                        data-page="2">
                  <i class="fa-solid fa-plus mr-1"></i>
                  Xem thêm (<%= @total_appointments - @appointments.size %> lịch hẹn)
                </button>
              </div>
            <% end %>
          </div>
        </turbo-frame>
      </div>

      <!-- Today's Activities -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-900">
            <i class="fa-solid fa-clock-rotate-left text-green-500 mr-2"></i>Hoạt động hôm nay
          </h3>
          <span class="text-xs text-gray-500"><%= @today_activities.size %> hoạt động</span>
        </div>
        <ul class="divide-y divide-gray-100 max-h-80 overflow-y-auto">
          <% @today_activities.each do |activity| %>
            <li class="p-4 hover:bg-gray-50 transition-colors">
              <div class="flex items-start space-x-3">
                <div class="mt-0.5">
                  <% icon = case activity.action
                     when 'login' then 'fa-right-to-bracket text-blue-500'
                     when 'contact.pick' then 'fa-dollar-sign text-brand-blue'
                     when 'contact.create' then 'fa-user-plus text-green-500'
                     when 'contact.update' then 'fa-pen text-orange-500'
                     when 'contact.call' then 'fa-phone text-green-600'
                     when 'contact.close' then 'fa-check-circle text-emerald-500'
                     else 'fa-circle-dot text-gray-400'
                     end
                  %>
                  <i class="fa-solid <%= icon %>"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm text-gray-900">
                    <% if activity.action == 'contact.pick' %>
                      Nhận khách hàng <strong><%= activity.subject&.name %></strong>
                    <% elsif activity.action == 'contact.create' %>
                      Tạo khách hàng <strong><%= activity.subject&.name %></strong>
                    <% elsif activity.action == 'contact.update' %>
                      Cập nhật <strong><%= activity.subject&.name %></strong>
                    <% elsif activity.action == 'contact.call' %>
                      Gọi điện cho <strong><%= activity.subject&.name %></strong>
                    <% elsif activity.action == 'contact.close' %>
                      Chốt đơn <strong><%= activity.subject&.name %></strong>
                    <% else %>
                      <%= activity.action.gsub('contact.', '').humanize %> <strong><%= activity.subject&.name %></strong>
                    <% end %>
                  </p>
                  <p class="text-xs text-gray-400 mt-0.5"><%= activity.created_at.strftime("%H:%M") %></p>
                </div>
              </div>
            </li>
          <% end %>
          <% if @today_activities.empty? %>
            <li class="p-8 text-center">
              <div class="text-gray-400">
                <i class="fa-solid fa-coffee text-3xl mb-2"></i>
                <p class="text-sm">Chưa có hoạt động nào hôm nay.</p>
                <p class="text-xs mt-1">Bắt đầu bằng cách nhận một khách hàng mới!</p>
              </div>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>

  <!-- Slide Over Drawer for Contact Details -->
  <div id="main-slide-over" 
       data-controller="slide-over"
       data-slide-over-target="container"
       class="relative z-50 hidden" 
       aria-labelledby="slide-over-title" 
       role="dialog" 
       aria-modal="true">
       
    <!-- Backdrop - clickable to close -->
    <div data-slide-over-target="backdrop" 
         class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity opacity-0 cursor-pointer"
         data-action="click->slide-over#close"></div>

    <!-- Content wrapper - pointer-events-none so clicks pass through to backdrop -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute inset-0 overflow-hidden">
        <div class="fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
          
          <!-- Panel - pointer-events-auto to capture panel clicks -->
          <div data-slide-over-target="panel" 
               class="pointer-events-auto w-screen max-w-2xl transform transition ease-in-out duration-500 translate-x-full bg-white shadow-xl flex flex-col h-full">
            
            <!-- Panel Header -->
            <div class="px-4 py-6 bg-gray-50 sm:px-6 border-b border-gray-200">
               <div class="flex items-start justify-between">
                 <h2 class="text-lg font-medium text-gray-900" id="slide-over-title">Chi tiết khách hàng</h2>
                 <div class="ml-3 flex h-7 items-center">
                   <button type="button" 
                           class="relative rounded-md text-gray-400 hover:text-gray-500 focus:outline-none"
                           data-action="click->slide-over#close">
                     <span class="absolute -inset-2.5"></span>
                     <span class="sr-only">Đóng</span>
                     <i class="fa-solid fa-xmark text-xl"></i>
                   </button>
                 </div>
               </div>
            </div>

            <!-- Panel Content: Full Contact Details -->
            <div class="flex-1 overflow-y-auto bg-white">
               <turbo-frame id="contact_preview_frame" class="block">
                   <div class="h-96 flex flex-col items-center justify-center text-gray-400 space-y-4">
                      <i class="fa-solid fa-spinner fa-spin text-3xl"></i>
                      <p>Đang tải dữ liệu...</p>
                   </div>
               </turbo-frame>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .workspace-tab {
    color: #6b7280;
    border-color: transparent;
  }
  .workspace-tab:hover {
    color: #374151;
    border-color: #d1d5db;
  }
  .workspace-tab[aria-selected="true"] {
    color: #0B387A;
    border-color: #0B387A;
    background-color: #EFF6FF;
  }
</style>
