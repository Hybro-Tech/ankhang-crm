<%# TASK-PROFILE: User profile page - Redesigned for better UX %>
<% content_for :page_title, "Hồ sơ cá nhân" %>

<% content_for :breadcrumb do %>
  <%= link_to t("dashboard.title"), root_path, class: "hover:text-gray-700" %>
  <i class="fa-solid fa-chevron-right text-xs mx-2"></i>
  <span class="text-gray-900"><%= t("profiles.title") %></span>
<% end %>

<div class="w-full">
  <h1 class="text-2xl font-bold text-gray-900 mb-6"><%= t("profiles.account_settings") %></h1>

  <div class="space-y-6">
    <%# ===== Card 1: Personal Info ===== %>
    <div class="bg-white shadow rounded-lg">
      <div class="border-b border-gray-200 px-6 py-4">
        <h2 class="text-lg leading-6 font-semibold text-gray-900">
          <i class="fa-solid fa-user text-brand-blue mr-2"></i>
          <%= t("profiles.personal_info") %>
        </h2>
      </div>
      
      <%= form_with model: @user, url: profile_path, method: :patch, local: true, multipart: true, data: { controller: "avatar-preview" } do |f| %>
        <div class="p-6">
          <div class="flex flex-col sm:flex-row items-start gap-6">
            <%# Avatar Section %>
            <div class="flex-shrink-0 w-full sm:w-auto flex flex-col items-center">
              <div class="relative group">
                <% if @user.avatar.attached? %>
                  <%= image_tag @user.avatar.variant(:medium), 
                                class: "h-28 w-28 rounded-full border-4 border-gray-100 object-cover shadow-md", 
                                alt: "Avatar",
                                id: "avatar-current",
                                data: { avatar_preview_target: "current" } %>
                <% else %>
                  <%= image_tag "https://ui-avatars.com/api/?name=#{URI.encode_www_form_component(@user.name.presence || @user.email.first)}&size=128&background=0B387A&color=fff", 
                                class: "h-28 w-28 rounded-full border-4 border-gray-100 shadow-md", 
                                alt: "Avatar",
                                id: "avatar-current",
                                data: { avatar_preview_target: "current" } %>
                <% end %>
                
                <%# Preview image (hidden by default) %>
                <img id="avatar-preview" 
                     src="" 
                     alt="Preview" 
                     class="h-28 w-28 rounded-full border-4 border-green-300 object-cover shadow-md hidden"
                     data-avatar-preview-target="preview">
                
                <%# Upload overlay %>
                <label for="avatar-input" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                  <i class="fa-solid fa-camera text-white text-xl"></i>
                </label>
              </div>
              
              <%# Avatar file input (hidden) %>
              <%= f.file_field :avatar, 
                               accept: "image/jpeg,image/png,image/gif,image/webp",
                               class: "hidden",
                               id: "avatar-input",
                               data: { avatar_preview_target: "input", action: "change->avatar-preview#preview" } %>
              
              <div class="mt-3 flex flex-col items-center gap-1">
                <label for="avatar-input" class="text-sm text-brand-blue hover:text-blue-800 cursor-pointer font-medium">
                  <i class="fa-solid fa-upload mr-1"></i><%= t("profiles.avatar.upload") %>
                </label>
                <% if @user.avatar.attached? %>
                  <%= button_to destroy_avatar_profile_path, method: :delete, 
                                form: { data: { turbo_confirm: t("profiles.avatar.confirm_remove") } },
                                class: "text-sm text-red-600 hover:text-red-800" do %>
                    <i class="fa-solid fa-trash mr-1"></i><%= t("profiles.avatar.remove") %>
                  <% end %>
                <% end %>
              </div>
            </div>
            
            <%# Form Fields Grid %>
            <div class="flex-1 w-full">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <%# Name %>
                <div>
                  <%= f.label :name, t("profiles.fields.name"), class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.text_field :name, class: "block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm" %>
                  <% if @user.errors[:name].any? %>
                    <p class="mt-1 text-sm text-red-600"><%= @user.errors[:name].first %></p>
                  <% end %>
                </div>

                <%# Role (read-only) %>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"><%= t("profiles.fields.role") %></label>
                  <input type="text" 
                         value="<%= @user.roles.pluck(:name).join(', ').presence || 'Chưa phân quyền' %>" 
                         disabled 
                         class="block w-full border border-gray-200 bg-gray-50 rounded-md shadow-sm py-2.5 px-3 text-gray-500 text-sm">
                </div>

                <%# Email %>
                <div>
                  <%= f.label :email, t("profiles.fields.email"), class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.email_field :email, class: "block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm" %>
                  <% if @user.errors[:email].any? %>
                    <p class="mt-1 text-sm text-red-600"><%= @user.errors[:email].first %></p>
                  <% end %>
                </div>

                <%# Phone %>
                <div>
                  <%= f.label :phone, t("profiles.fields.phone"), class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= f.text_field :phone, class: "block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm", placeholder: "0912 345 678" %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <%# Divider with section title %>
        <div class="border-t border-gray-200 px-6 py-4 bg-gray-50">
          <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
            <i class="fa-solid fa-location-dot text-brand-blue mr-2"></i>
            Thông tin địa chỉ
          </h3>
        </div>

        <div class="p-6 pt-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <%# Region/Area %>
            <div>
              <%= f.label :region_id, t("profiles.fields.region"), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.select :region_id, 
                           Region.for_select, 
                           { include_blank: t("profiles.placeholders.select_region"), selected: @user.region_id },
                           class: "block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm bg-white" %>
            </div>

            <%# Empty for balance %>
            <div class="hidden sm:block"></div>

            <%# Address - full width %>
            <div class="sm:col-span-2">
              <%= f.label :address, t("profiles.fields.address"), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_area :address, rows: 2, class: "block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm resize-none", placeholder: t("profiles.placeholders.address") %>
            </div>
          </div>

          <%# Submit Button %>
          <div class="flex justify-end pt-6">
            <%= f.submit t("profiles.save_info"), class: "inline-flex items-center justify-center py-2.5 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-blue hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue cursor-pointer transition-colors" %>
          </div>
        </div>
      <% end %>
    </div>

    <%# ===== Card 2: Security ===== %>
    <div class="bg-white shadow rounded-lg">
      <div class="border-b border-gray-200 px-6 py-4">
        <h2 class="text-lg leading-6 font-semibold text-gray-900">
          <i class="fa-solid fa-shield-halved text-brand-orange mr-2"></i>
          <%= t("profiles.security") %>
        </h2>
      </div>
      
      <%= form_with url: update_password_profile_path, method: :patch, local: true do |f| %>
        <div class="p-6">
          <div class="max-w-md space-y-4">
            <%# Current Password %>
            <div>
              <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1"><%= t("profiles.fields.current_password") %></label>
              <input type="password" 
                     name="current_password" 
                     id="current_password" 
                     required
                     class="block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm">
            </div>

            <%# New Password %>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-1"><%= t("profiles.fields.new_password") %></label>
              <input type="password" 
                     name="password" 
                     id="password" 
                     required
                     minlength="6"
                     class="block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm">
              <p class="mt-1 text-xs text-gray-500"><%= t("profiles.password_hint") %></p>
            </div>

            <%# Confirm Password %>
            <div>
              <label for="password_confirmation" class="block text-sm font-medium text-gray-700 mb-1"><%= t("profiles.fields.password_confirmation") %></label>
              <input type="password" 
                     name="password_confirmation" 
                     id="password_confirmation" 
                     required
                     class="block w-full border border-gray-300 rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-brand-blue text-sm">
            </div>

            <%# Submit Button %>
            <div class="flex justify-start pt-2">
              <button type="submit" class="inline-flex items-center justify-center py-2.5 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-orange hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-orange cursor-pointer transition-colors">
                <i class="fa-solid fa-key mr-2"></i>
                <%= t("profiles.change_password") %>
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <%# ===== Card 3: Activity History ===== %>
    <div class="bg-white shadow rounded-lg">
      <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg leading-6 font-semibold text-gray-900">
          <i class="fa-solid fa-clock-rotate-left text-gray-400 mr-2"></i>
          <%= t("profiles.activity_history") %>
        </h2>
        <% if @total_events > 0 %>
          <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
            <%= t("profiles.activity.showing", from: ((@page - 1) * @per_page) + 1, to: [(@page * @per_page), @total_events].min, total: @total_events) %>
          </span>
        <% end %>
      </div>
      
      <div class="p-6">
        <% if @recent_events.any? %>
          <div class="overflow-x-auto -mx-6 px-6">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t("profiles.activity.time") %></th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t("profiles.activity.action") %></th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t("profiles.activity.path") %></th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t("profiles.activity.ip") %></th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @recent_events.each do |event| %>
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                      <%= event.created_at.in_time_zone(Setting.timezone).strftime("%d/%m/%Y %H:%M") %>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium
                        <%= case event.method
                            when 'GET' then 'bg-blue-100 text-blue-800'
                            when 'POST' then 'bg-green-100 text-green-800'
                            when 'PATCH', 'PUT' then 'bg-yellow-100 text-yellow-800'
                            when 'DELETE' then 'bg-red-100 text-red-800'
                            else 'bg-gray-100 text-gray-800'
                            end %>">
                        <%= event.method %>
                      </span>
                      <span class="ml-2 text-gray-700"><%= event.action %></span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate" title="<%= event.path %>">
                      <%= truncate(event.path, length: 50) %>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-mono">
                      <%= event.ip_address %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <%# Pagination Controls %>
          <% if @total_pages > 1 %>
            <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
              <div class="flex items-center space-x-2">
                <% if @page > 1 %>
                  <%= link_to profile_path(page: @page - 1), class: "px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors" do %>
                    <i class="fa-solid fa-chevron-left mr-1"></i> <%= t("profiles.pagination.prev") %>
                  <% end %>
                <% else %>
                  <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
                    <i class="fa-solid fa-chevron-left mr-1"></i> <%= t("profiles.pagination.prev") %>
                  </span>
                <% end %>

                <%# Page numbers %>
                <div class="hidden sm:flex items-center space-x-1">
                  <% page_range = [[@page - 2, 1].max, [@page + 2, @total_pages].min] %>
                  <% if page_range[0] > 1 %>
                    <%= link_to "1", profile_path(page: 1), class: "px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
                    <% if page_range[0] > 2 %>
                      <span class="px-2 text-gray-500">...</span>
                    <% end %>
                  <% end %>
                  
                  <% (page_range[0]..page_range[1]).each do |p| %>
                    <% if p == @page %>
                      <span class="px-3 py-2 text-sm font-medium text-white bg-brand-blue border border-brand-blue rounded-md"><%= p %></span>
                    <% else %>
                      <%= link_to p.to_s, profile_path(page: p), class: "px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
                    <% end %>
                  <% end %>

                  <% if page_range[1] < @total_pages %>
                    <% if page_range[1] < @total_pages - 1 %>
                      <span class="px-2 text-gray-500">...</span>
                    <% end %>
                    <%= link_to @total_pages.to_s, profile_path(page: @total_pages), class: "px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
                  <% end %>
                </div>

                <% if @page < @total_pages %>
                  <%= link_to profile_path(page: @page + 1), class: "px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors" do %>
                    <%= t("profiles.pagination.next") %> <i class="fa-solid fa-chevron-right ml-1"></i>
                  <% end %>
                <% else %>
                  <span class="px-3 py-2 text-sm font-medium text-gray-400 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
                    <%= t("profiles.pagination.next") %> <i class="fa-solid fa-chevron-right ml-1"></i>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-12 text-gray-500">
            <i class="fa-solid fa-clock-rotate-left text-5xl text-gray-300 mb-4"></i>
            <p class="text-lg"><%= t("profiles.no_activity") %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
