<div class="min-h-screen bg-white flex flex-col">
  <%# Header with Date Filter %>
  <div class="sm:flex sm:items-center sm:justify-between mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">T·ªïng quan Qu·∫£n tr·ªã</h1>
      <p class="mt-1 text-sm text-gray-500">T·ªïng quan v·ªÅ hi·ªáu qu·∫£ kinh doanh to√†n h·ªá th·ªëng.</p>
    </div>
    <div class="mt-4 sm:mt-0 flex space-x-3">
      <%# Date Filter Dropdown %>
      <div class="relative" data-controller="dropdown">
        <button type="button" 
                class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none"
                data-action="click->dropdown#toggle">
          <i class="fa-solid fa-calendar mr-2 text-gray-400"></i>
          <%= case @period
              when "today" then "H√¥m nay"
              when "week" then "Tu·∫ßn n√†y"
              else "Th√°ng n√†y"
              end %>
          <i class="fa-solid fa-chevron-down ml-2 text-gray-400"></i>
        </button>
        <div class="hidden absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg border border-gray-200 z-10" data-dropdown-target="menu">
          <%= link_to "H√¥m nay", dashboard_index_path(period: "today"), 
              class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 #{'bg-blue-50 font-medium' if @period == 'today'}" %>
          <%= link_to "Tu·∫ßn n√†y", dashboard_index_path(period: "week"), 
              class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 #{'bg-blue-50 font-medium' if @period == 'week'}" %>
          <%= link_to "Th√°ng n√†y", dashboard_index_path(period: "month"), 
              class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 #{'bg-blue-50 font-medium' if @period == 'month'}" %>
        </div>
      </div>
      <span class="inline-flex rounded-md shadow-sm">
        <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-brand-blue hover:bg-blue-900 focus:outline-none shadow-md">
          <i class="fa-solid fa-download mr-2"></i> Xu·∫•t b√°o c√°o
        </button>
      </span>
    </div>
  </div>

  <%# KPI Cards - 5 columns matching wireframe %>
  <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5 mb-8">
    <%# Card 1: Total Contacts %>
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-blue-50 rounded-md p-3">
            <i class="fa-solid fa-users text-brand-blue text-xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">T·ªïng kh√°ch h√†ng</dt>
              <dd>
                <div class="text-2xl font-bold text-gray-900"><%= number_with_delimiter(@kpi[:total_contacts]) %></div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <%# Card 2: New Contacts (with trend) %>
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-orange-50 rounded-md p-3">
            <i class="fa-solid fa-user-plus text-brand-orange text-xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Kh√°ch m·ªõi</dt>
              <dd>
                <div class="text-2xl font-bold text-gray-900"><%= number_with_delimiter(@kpi[:new_contacts]) %></div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-5 py-3">
        <div class="text-sm">
          <% if @kpi[:new_contacts_trend] >= 0 %>
            <span class="text-green-600 font-semibold"><i class="fa-solid fa-arrow-up text-xs mr-1"></i> <%= @kpi[:new_contacts_trend] %>%</span>
          <% else %>
            <span class="text-red-600 font-semibold"><i class="fa-solid fa-arrow-down text-xs mr-1"></i> <%= @kpi[:new_contacts_trend].abs %>%</span>
          <% end %>
          <span class="text-gray-500 ml-1">so v·ªõi k·ª≥ tr∆∞·ªõc</span>
        </div>
      </div>
    </div>

    <%# Card 3: Won Deals (with trend) %>
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-green-50 rounded-md p-3">
            <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">ƒê∆°n ch·ªët th√†nh c√¥ng</dt>
              <dd>
                <div class="text-2xl font-bold text-gray-900"><%= @kpi[:won_deals_count] %></div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-5 py-3">
        <div class="text-sm">
          <% if @kpi[:won_deals_trend] >= 0 %>
            <span class="text-green-600 font-semibold"><i class="fa-solid fa-arrow-up text-xs mr-1"></i> <%= @kpi[:won_deals_trend] %>%</span>
          <% else %>
            <span class="text-red-600 font-semibold"><i class="fa-solid fa-arrow-down text-xs mr-1"></i> <%= @kpi[:won_deals_trend].abs %>%</span>
          <% end %>
          <span class="text-gray-500 ml-1">so v·ªõi k·ª≥ tr∆∞·ªõc</span>
        </div>
      </div>
    </div>

    <%# Card 4: Revenue (Phase 2 placeholder) %>
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-red-50 rounded-md p-3">
            <i class="fa-solid fa-sack-dollar text-brand-red text-xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Doanh thu</dt>
              <dd>
                <div class="text-2xl font-bold text-gray-900">-</div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-5 py-3">
        <div class="text-sm text-gray-400">Phase 2</div>
      </div>
    </div>

    <%# Card 5: Conversion Rate %>
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100 hover:shadow-md transition-shadow">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-purple-50 rounded-md p-3">
            <i class="fa-solid fa-percent text-purple-600 text-xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">T·ª∑ l·ªá ch·ªët</dt>
              <dd>
                <div class="text-2xl font-bold text-gray-900"><%= @kpi[:conversion_rate] %>%</div>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>


  <%# Charts Section %>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <%# Main Chart - Trend %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6 lg:col-span-2">
      <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">Bi·ªÉu ƒë·ªì hi·ªáu qu·∫£ kinh doanh</h3>
      <div class="relative h-72 w-full">
        <canvas id="mainChart"></canvas>
      </div>
    </div>

    <%# Pie Chart - Status Distribution %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
      <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">Ph√¢n b·ªë tr·∫°ng th√°i</h3>
      <div class="relative h-64 w-full flex justify-center">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <%# Comparison Charts %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <%# Team Comparison %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
      <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">üìä So s√°nh theo Team</h3>
      <div class="relative h-64 w-full">
        <canvas id="teamChart"></canvas>
      </div>
    </div>

    <%# Sales Comparison %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
      <h3 class="text-lg leading-6 font-semibold text-gray-900 mb-4">üë• So s√°nh Sales</h3>
      <div class="relative h-64 w-full">
        <canvas id="salesChart"></canvas>
      </div>
    </div>
  </div>

  <%# Bottom Section: Tables %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <%# Top Performers %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-semibold text-gray-900">üèÜ Top Nh√¢n vi√™n xu·∫•t s·∫Øc</h3>
        <%= link_to "Xem t·∫•t c·∫£", users_path, class: "text-sm text-brand-blue hover:text-blue-800 font-medium" %>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">#</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H·ªç t√™n</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hi·ªáu su·∫•t</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @top_performers.each_with_index do |performer, index| %>
              <% 
                medal = case index
                        when 0 then 'ü•á'
                        when 1 then 'ü•à'
                        when 2 then 'ü•â'
                        else (index + 1).to_s
                        end
                ring_color = case index
                             when 0 then 'ring-yellow-400 ring-2'
                             when 1 then 'ring-gray-300 ring-2'
                             when 2 then 'ring-orange-400 ring-2'
                             else ''
                             end
                total = performer.picked_count
                closed = performer.closed_count
                rate = total > 0 ? (closed.to_f / total * 100).round : 0
              %>
              <tr class="<%= 'bg-yellow-50/50' if index == 0 %>">
                <td class="px-4 py-4 whitespace-nowrap text-center">
                  <span class="text-lg"><%= medal %></span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <img class="h-10 w-10 rounded-full <%= ring_color %>" 
                           src="https://ui-avatars.com/api/?name=<%= URI.encode_www_form_component(performer.name) %>&background=<%= index == 0 ? 'fbbf24' : 'random' %>" 
                           alt="<%= performer.name %>">
                    </div>
                    <div class="ml-3">
                      <div class="text-sm font-semibold text-gray-900"><%= performer.name %></div>
                      <div class="text-xs text-gray-500"><%= closed %> ch·ªët / <%= total %> picked</div>
                    </div>
                  </div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                  <div class="flex items-center space-x-2">
                    <div class="flex-1 bg-gray-200 rounded-full h-2 w-24">
                      <div class="bg-gradient-to-r from-brand-blue to-green-500 h-2 rounded-full" style="width: <%= rate %>%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-600"><%= rate %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
            <% if @top_performers.empty? %>
              <tr>
                <td colspan="3" class="px-6 py-8 text-center text-gray-500">
                  <i class="fa-solid fa-trophy text-3xl text-gray-300 mb-2"></i>
                  <p class="text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu nh√¢n vi√™n</p>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <%# Recent Activities %>
    <div class="bg-white shadow-sm rounded-xl border border-gray-100 overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-semibold text-gray-900">üîî Ho·∫°t ƒë·ªông h·ªá th·ªëng</h3>
        <%= link_to "Xem t·∫•t c·∫£", admin_logs_path, class: "text-sm text-brand-blue hover:text-blue-800 font-medium" %>
      </div>
      <ul class="divide-y divide-gray-200 max-h-80 overflow-y-auto">
        <% @recent_activities.each do |activity| %>
          <li class="p-4 hover:bg-gray-50 transition-colors">
            <div class="flex space-x-3">
              <div class="flex-shrink-0">
                <% 
                  icon_class = case activity.action.to_s
                   when /create/ then 'fa-plus-circle text-green-500'
                   when /update/ then 'fa-edit text-yellow-500'
                   when /destroy/, /delete/ then 'fa-trash text-red-500'
                   when /login_failed/ then 'fa-times-circle text-red-500'
                   when /login/ then 'fa-sign-in-alt text-blue-500'
                   when /logout/ then 'fa-sign-out-alt text-gray-500'
                   when /pick/ then 'fa-hand-pointer text-orange-500'
                   when /assign/ then 'fa-user-check text-purple-500'
                   else 'fa-circle text-gray-400'
                   end 
                %>
                <i class="fa-solid <%= icon_class %>"></i>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm text-gray-900">
                  <span class="font-medium"><%= activity.user_name || activity.user&.name || 'H·ªá th·ªëng' %></span>
                  <span class="<%= activity.action.to_s.include?('failed') ? 'text-red-600 font-medium' : 'text-gray-600' %>">
                    <%= activity.action %>
                  </span>
                  <% if activity.subject_type.present? %>
                    <span class="text-gray-500"><%= activity.subject_type.underscore.humanize %></span>
                  <% end %>
                </p>
                <p class="text-xs text-gray-400 mt-1"><%= time_ago_in_words(activity.created_at) %> tr∆∞·ªõc</p>
              </div>
            </div>
          </li>
        <% end %>
        <% if @recent_activities.empty? %>
          <li class="p-4 text-center text-gray-500 text-sm">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</li>
        <% end %>
      </ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("turbo:load", function() {
    // Main Chart (Line)
    const ctxMain = document.getElementById('mainChart');
    if (ctxMain) {
      new Chart(ctxMain.getContext('2d'), {
        type: 'line',
        data: {
          labels: <%= raw @chart_data[:labels].to_json %>,
          datasets: [{
            label: 'Kh√°ch h√†ng m·ªõi',
            data: <%= raw @chart_data[:contacts].to_json %>,
            borderColor: '#0B387A',
            tension: 0.4,
            fill: false
          }, {
            label: 'Ch·ªët ƒë∆°n',
            data: <%= raw @chart_data[:deals].to_json %>,
            borderColor: '#10B981',
            tension: 0.4,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Pie Chart - Real data from @status_distribution
    const ctxPie = document.getElementById('pieChart');
    if (ctxPie) {
      const statusData = <%= raw @status_distribution.to_json %>;
      new Chart(ctxPie.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusData).map(s => {
            const labels = {
              'new': 'M·ªõi',
              'potential': 'Ti·ªÅm nƒÉng', 
              'caring': 'ƒêang chƒÉm s√≥c',
              'closed_new': 'Ch·ªët m·ªõi',
              'closed_renew': 'Ch·ªët gia h·∫°n',
              'failed': 'Th·∫•t b·∫°i'
            };
            return labels[s] || s;
          }),
          datasets: [{
            data: Object.values(statusData),
            backgroundColor: ['#0B387A', '#FBBF24', '#3B82F6', '#10B981', '#059669', '#EF4444'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          cutout: '60%'
        }
      });
    }

    // Team Comparison Chart
    const ctxTeam = document.getElementById('teamChart');
    if (ctxTeam) {
      new Chart(ctxTeam.getContext('2d'), {
        type: 'bar',
        data: {
          labels: <%= raw @team_stats.map(&:name).to_json %>,
          datasets: [{
            label: 'S·ªë kh√°ch h√†ng',
            data: <%= raw @team_stats.map(&:contacts_count).to_json %>,
            backgroundColor: ['#0B387A', '#F37021', '#10B981', '#FBBF24', '#8B5CF6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Sales Comparison Chart
    const ctxSales = document.getElementById('salesChart');
    if (ctxSales) {
      new Chart(ctxSales.getContext('2d'), {
        type: 'bar',
        data: {
          labels: <%= raw @sales_stats.map(&:name).to_json %>,
          datasets: [{
            label: 'Kh√°ch ƒë∆∞·ª£c assign',
            data: <%= raw @sales_stats.map(&:contacts_count).to_json %>,
            backgroundColor: ['#0B387A', '#F37021', '#10B981', '#FBBF24', '#8B5CF6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  });
</script>
