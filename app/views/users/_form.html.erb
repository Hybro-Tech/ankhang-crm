<%# User Form - Tab-Based Layout (UI/UX ProMax) %>
<%= form_with model: user, local: true, class: "h-full flex flex-col" do |f| %>
  
  <%# Error Messages %>
  <% if user.errors.any? %>
    <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
      <div class="flex items-center text-red-800">
        <i class="fa-solid fa-exclamation-triangle mr-2"></i>
        <span class="font-semibold">C√≥ <%= user.errors.count %> l·ªói c·∫ßn s·ª≠a:</span>
      </div>
      <ul class="mt-2 text-sm text-red-700 list-disc list-inside ml-6">
        <% user.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# Main Container with Tabs %>
  <div class="flex-1 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col" data-controller="tabs">
    
    <%# Tab Navigation %>
    <div class="border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
      <nav class="flex -mb-px px-6" aria-label="Tabs">
        <button type="button"
                data-tabs-target="tab"
                data-tab-index="0"
                data-action="click->tabs#switch"
                class="py-4 px-6 text-sm font-semibold border-b-2 transition-colors text-brand-blue border-brand-blue">
          <i class="fa-solid fa-user mr-2"></i>
          Th√¥ng tin c∆° b·∫£n
        </button>
        <button type="button"
                data-tabs-target="tab"
                data-tab-index="1"
                data-action="click->tabs#switch"
                class="py-4 px-6 text-sm font-semibold border-b-2 transition-colors text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
          <i class="fa-solid fa-shield-halved mr-2"></i>
          Ph√¢n quy·ªÅn & B·∫£o m·∫≠t
        </button>
        <% if @service_types.present? %>
          <button type="button"
                  data-tabs-target="tab"
                  data-tab-index="2"
                  data-action="click->tabs#switch"
                  class="py-4 px-6 text-sm font-semibold border-b-2 transition-colors text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
            <i class="fa-solid fa-gauge-high mr-2"></i>
            Gi·ªõi h·∫°n Pick
            <% if user.user_service_type_limits.any? %>
              <span class="ml-2 bg-brand-blue text-white text-xs px-2 py-0.5 rounded-full"><%= user.user_service_type_limits.size %></span>
            <% end %>
          </button>
        <% end %>
      </nav>
    </div>

    <%# Tab Panels %>
    <div class="flex-1 overflow-auto p-6">
      
      <%# TAB 1: Basic Info %>
      <div data-tabs-target="panel" class="">
        <div class="space-y-6">
          
          <%# Row 1: Name + Email %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <%= f.label :name, "H·ªç v√† t√™n *", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                  <i class="fa-solid fa-user"></i>
                </span>
                <%= f.text_field :name, 
                    class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                    placeholder: "Nguy·ªÖn VƒÉn A" %>
              </div>
            </div>
            <div>
              <%= f.label :email, "Email *", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                  <i class="fa-solid fa-envelope"></i>
                </span>
                <%= f.email_field :email, 
                    class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                    placeholder: "email@example.com" %>
              </div>
            </div>
          </div>

          <%# Row 2: Username + Phone %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <%= f.label :username, "T√™n ƒëƒÉng nh·∫≠p", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                  <i class="fa-solid fa-at"></i>
                </span>
                <%= f.text_field :username, 
                    class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                    placeholder: "username" %>
              </div>
            </div>
            <div>
              <%= f.label :phone, "S·ªë ƒëi·ªán tho·∫°i", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                  <i class="fa-solid fa-phone"></i>
                </span>
                <%= f.telephone_field :phone, 
                    class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                    placeholder: "0912 345 678" %>
              </div>
            </div>
          </div>

          <%# Row 3: Region + Status %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">V√πng/Mi·ªÅn</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 z-10">
                  <i class="fa-solid fa-map-location-dot"></i>
                </span>
                <%= f.collection_select :region_id, Region.all, :id, :name, 
                    { include_blank: "-- Ch·ªçn v√πng/mi·ªÅn --" }, 
                    { class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors bg-white appearance-none cursor-pointer" } %>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1.5">Tr·∫°ng th√°i</label>
              <%= f.select :status, 
                  [["üü¢ ƒêang ho·∫°t ƒë·ªông", "active"], ["üî¥ Ng·ª´ng ho·∫°t ƒë·ªông", "inactive"], ["‚è∏Ô∏è T·∫°m kh√≥a", "suspended"]], 
                  {}, 
                  { class: "w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors bg-white appearance-none cursor-pointer" } %>
            </div>
          </div>

          <%# Row 4: Address (full width) %>
          <div>
            <%= f.label :address, "ƒê·ªãa ch·ªâ chi ti·∫øt", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
            <div class="relative">
              <span class="absolute top-3 left-0 pl-3 flex items-start text-gray-400">
                <i class="fa-solid fa-location-dot"></i>
              </span>
              <%= f.text_area :address,
                  rows: 2,
                  class: "w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors resize-none",
                  placeholder: "S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë" %>
            </div>
          </div>
        </div>
      </div>

      <%# TAB 2: Permissions & Security %>
      <div data-tabs-target="panel" class="hidden">
        <div class="space-y-6">
          
          <%# Role %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Vai tr√≤ (Role) *</label>
            <p class="text-sm text-gray-500 mb-2">Quy·∫øt ƒë·ªãnh nh·ªØng g√¨ nh√¢n vi√™n c√≥ th·ªÉ xem v√† thao t√°c trong h·ªá th·ªëng</p>
            <%= f.collection_select :role_ids, Role.all, :id, :name, 
                { include_blank: "-- Ch·ªçn vai tr√≤ --" }, 
                { class: "w-full", 
                  multiple: false, 
                  name: "user[role_ids][]",
                  data: { controller: "tom-select", tom_select_placeholder_value: "T√¨m v√† ch·ªçn vai tr√≤..." } } %>
          </div>

          <%# Teams %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Thu·ªôc Team</label>
            <p class="text-sm text-gray-500 mb-2">C√≥ th·ªÉ ch·ªçn nhi·ªÅu team. Nh√¢n vi√™n s·∫Ω nh·∫≠n contact ƒë∆∞·ª£c route ƒë·∫øn c√°c team n√†y.</p>
            <%= f.collection_select :team_ids, Team.all, :id, :name, 
                {}, 
                { class: "w-full",
                  multiple: true,
                  data: { controller: "tom-select", tom_select_placeholder_value: "T√¨m v√† ch·ªçn team..." } } %>
          </div>

          <%# Password Section - Collapsible %>
          <div class="border border-gray-200 rounded-lg overflow-hidden" data-controller="collapse">
            <button type="button" 
                    class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors text-left"
                    data-action="click->collapse#toggle">
              <div class="flex items-center">
                <i class="fa-solid fa-key text-gray-400 mr-3"></i>
                <span class="font-medium text-gray-700"><%= user.new_record? ? "ƒê·∫∑t m·∫≠t kh·∫©u *" : "ƒê·ªïi m·∫≠t kh·∫©u" %></span>
              </div>
              <i class="fa-solid fa-chevron-down text-gray-400 transition-transform" data-collapse-target="icon"></i>
            </button>
            <div class="<%= 'hidden' unless user.new_record? %> p-4 border-t border-gray-200 bg-white" data-collapse-target="content">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <%= f.label :password, "M·∫≠t kh·∫©u m·ªõi", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
                  <div class="relative" data-controller="password-toggle">
                    <%= f.password_field :password, 
                        class: "w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-10 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors", 
                        placeholder: user.new_record? ? "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" : "ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi",
                        data: { password_toggle_target: "input" } %>
                    <button type="button" 
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
                            data-action="click->password-toggle#toggle">
                      <i class="fa-solid fa-eye" data-password-toggle-target="icon"></i>
                    </button>
                  </div>
                </div>
                <div>
                  <%= f.label :password_confirmation, "X√°c nh·∫≠n m·∫≠t kh·∫©u", class: "block text-sm font-medium text-gray-700 mb-1.5" %>
                  <div class="relative" data-controller="password-toggle">
                    <%= f.password_field :password_confirmation, 
                        class: "w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-10 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                        placeholder: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
                        data: { password_toggle_target: "input" } %>
                    <button type="button" 
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
                            data-action="click->password-toggle#toggle">
                      <i class="fa-solid fa-eye" data-password-toggle-target="icon"></i>
                    </button>
                  </div>
                </div>
              </div>
              <% unless user.new_record? %>
                <p class="mt-3 text-sm text-gray-500">
                  <i class="fa-solid fa-info-circle mr-1"></i>
                  ƒê·ªÉ tr·ªëng c·∫£ hai √¥ n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u.
                </p>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# TAB 3: Service Type Limits %>
      <% if @service_types.present? %>
        <div data-tabs-target="panel" class="hidden">
          <div class="" 
               data-controller="nested-form" 
               data-nested-form-index-value="<%= user.user_service_type_limits.size %>">
            
            <div class="mb-6">
              <h3 class="text-lg font-bold text-gray-900">Gi·ªõi h·∫°n Pick theo Lo·∫°i nhu c·∫ßu</h3>
              <p class="mt-1 text-sm text-gray-500">Th√™m c√°c lo·∫°i nhu c·∫ßu m√† nh√¢n vi√™n n√†y ƒë∆∞·ª£c ph√©p pick t·ª´ Smart Routing.</p>
            </div>

            <%# Add new limit row %>
            <div class="flex items-center gap-3 mb-4 p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <div class="flex-1">
                <select data-nested-form-target="serviceTypeSelect" 
                        data-controller="tom-select"
                        data-tom-select-placeholder-value="T√¨m v√† ch·ªçn lo·∫°i nhu c·∫ßu..."
                        class="w-full">
                  <option value="">-- Ch·ªçn lo·∫°i nhu c·∫ßu ƒë·ªÉ th√™m --</option>
                  <% existing_ids = user.user_service_type_limits.map(&:service_type_id) %>
                  <% @service_types.each do |st| %>
                    <option value="<%= st.id %>" <%= 'disabled' if existing_ids.include?(st.id) %>>
                      <%= st.name %>
                    </option>
                  <% end %>
                </select>
              </div>
              <button type="button" 
                      data-action="click->nested-form#add"
                      class="inline-flex items-center px-4 py-2.5 bg-brand-blue text-white rounded-lg hover:bg-blue-900 font-medium transition-colors">
                <i class="fa-solid fa-plus mr-2"></i>
                Th√™m
              </button>
            </div>

            <%# Existing limits container %>
            <div data-nested-form-target="container" class="space-y-3">
              <% if user.user_service_type_limits.any? %>
                <%= f.fields_for :user_service_type_limits, user.user_service_type_limits.includes(:service_type).sort_by { |l| l.service_type&.name.to_s } do |limit_form| %>
                  <% service_type = limit_form.object.service_type %>
                  <div class="nested-fields flex items-center gap-4 p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 transition-colors"
                       data-service-type-id="<%= service_type&.id %>">
                    <%= limit_form.hidden_field :id %>
                    <%= limit_form.hidden_field :service_type_id %>
                    <%= limit_form.hidden_field :_destroy, value: false %>
                    
                    <div class="flex items-center flex-1 min-w-0">
                      <i class="fa-solid fa-folder text-brand-blue mr-3"></i>
                      <span class="font-medium text-gray-900 truncate"><%= service_type&.name || "N/A" %></span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                      <label class="text-sm text-gray-500">Gi·ªõi h·∫°n/Ng√†y:</label>
                      <%= limit_form.number_field :max_pick_per_day,
                          min: 1,
                          max: 100,
                          class: "w-20 text-center border border-gray-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors",
                          placeholder: "10" %>
                    </div>
                    
                    <button type="button" 
                            data-action="click->nested-form#remove"
                            class="inline-flex items-center px-3 py-2 text-red-600 hover:text-white hover:bg-red-600 border border-red-200 hover:border-red-600 rounded-lg transition-colors"
                            title="Xo√°">
                      <i class="fa-solid fa-trash-can"></i>
                    </button>
                  </div>
                <% end %>
              <% end %>
            </div>

            <%# Empty state %>
            <div class="empty-state <%= 'hidden' if user.user_service_type_limits.any? %> text-center py-8 text-gray-400">
              <i class="fa-solid fa-inbox text-4xl mb-3"></i>
              <p>Ch∆∞a c√≥ lo·∫°i nhu c·∫ßu n√†o ƒë∆∞·ª£c th√™m.</p>
              <p class="text-sm mt-1">Nh√¢n vi√™n n√†y s·∫Ω kh√¥ng nh·∫≠n ƒë∆∞·ª£c contact t·ª´ Smart Routing.</p>
            </div>

            <%# Template for new items %>
            <template data-nested-form-target="template">
              <div class="nested-fields flex items-center gap-4 p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 transition-colors"
                   data-service-type-id="SERVICE_TYPE_ID">
                <input type="hidden" name="user[user_service_type_limits_attributes][NEW_RECORD][service_type_id]" value="SERVICE_TYPE_ID">
                
                <div class="flex items-center flex-1 min-w-0">
                  <i class="fa-solid fa-folder text-brand-blue mr-3"></i>
                  <span class="font-medium text-gray-900 truncate">SERVICE_TYPE_NAME</span>
                </div>
                
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-500">Gi·ªõi h·∫°n/Ng√†y:</label>
                  <input type="number" 
                         name="user[user_service_type_limits_attributes][NEW_RECORD][max_pick_per_day]" 
                         value="10" 
                         min="1" 
                         max="100"
                         class="w-20 text-center border border-gray-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition-colors">
                </div>
                
                <button type="button" 
                        data-action="click->nested-form#remove"
                        class="inline-flex items-center px-3 py-2 text-red-600 hover:text-white hover:bg-red-600 border border-red-200 hover:border-red-600 rounded-lg transition-colors"
                        title="Xo√°">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
              </div>
            </template>

            <div class="mt-4 bg-blue-50 text-blue-800 text-sm p-3 rounded-lg flex items-start gap-2">
              <i class="fa-solid fa-info-circle mt-0.5"></i>
              <span>
                <strong>L∆∞u √Ω:</strong> Nh√¢n vi√™n ch·ªâ nh·∫≠n ƒë∆∞·ª£c contact t·ª´ Smart Routing cho c√°c lo·∫°i nhu c·∫ßu ƒë√£ th√™m ·ªü ƒë√¢y.
              </span>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <%# Sticky Footer Buttons %>
    <div class="border-t border-gray-200 bg-gray-50 px-6 py-4 flex items-center justify-center gap-4">
      <%= link_to users_path, class: "inline-flex items-center px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-100 font-medium transition-colors" do %>
        <i class="fa-solid fa-times mr-2"></i>
        H·ªßy b·ªè
      <% end %>
      <%= f.submit user.new_record? ? "T·∫°o nh√¢n vi√™n" : "L∆∞u thay ƒë·ªïi",
          class: "inline-flex items-center px-8 py-2.5 bg-brand-blue text-white rounded-lg hover:bg-blue-900 font-medium transition-colors shadow-lg shadow-blue-500/30 cursor-pointer" %>
    </div>
  </div>
<% end %>
